## Context
当前应用是一个基于 localStorage 的单机 BP 工具，用户需求扩展为支持多人实时协作的在线平台。关键要求是**保留现有本地使用版本**，创建双模式架构：本地模式（现有功能）和在线模式（新增协作功能）。需要引入 Supabase 作为后端服务，实现用户认证、房间管理和实时同步功能，同时确保本地模式完全独立工作。

## Goals / Non-Goals
- **Goals**:
  - 实现多人实时协作的 BP 功能
  - **完全保留现有本地模式功能不变**
  - **确保本地模式可完全离线使用**
  - 提供直观的双模式切换界面
  - 提供直观的用户权限管理
  - 确保数据同步的可靠性
  - 维护良好的用户体验

- **Non-Goals**:
  - 暂不支持语音或视频通话
  - 不实现聊天功能（可在后续版本添加）
  - 不支持复杂的权限层级（简化为房主/参与者两级）
  - 不实现历史版本回滚功能

## Decisions

### 技术栈选择
- **Decision**: 选择 Supabase 作为后端服务
- **理由**: Supabase 提供 PostgreSQL 数据库、实时订阅、认证和存储的一体化解决方案，与现有 React 技术栈集成良好，且提供免费层级适合初期开发

### 数据库设计
- **Decision**: 采用四个核心表：users, rooms, room_participants, bp_states
- **理由**: 分离用户、房间、参与关系和 BP 状态，符合关系数据库设计原则，便于查询和维护
- **表结构**:
  ```sql
  users: id, email, created_at, updated_at
  rooms: id, name, description, owner_id, is_public, created_at, updated_at
  room_participants: room_id, user_id, joined_at
  bp_states: room_id, hero_id, is_selected, updated_at
  ```

### 实时同步策略
- **Decision**: 使用 Supabase Realtime 进行数据库变更监听
- **理由**: 原生支持、低延迟、自动处理连接管理和重连，比 WebSocket 实现更简单可靠

### 冲突解决机制
- **Decision**: 采用最后写入获胜（Last Write Wins）策略
- **理由**: 协作编辑场景下简单有效，实现成本低，适合当前的权限控制模型（只有房主可编辑）

### 双模式架构设计
- **Decision**: 采用统一界面双模式架构 - 所有功能选项同时可见，通过按钮点击直接切换
- **理由**: 用户从一开始就能看到所有可用功能，提供更直观的用户体验，避免功能隐藏

### 用户体验设计
- **Decision**: 统一头部显示所有核心功能按钮，根据用户状态动态显示
- **理由**: 减少用户认知负担，提供清晰的功能入口
- **界面设计**:
  - **未登录用户**: 显示「注册登录」「本地模式」「加入房间」按钮
  - **已登录用户**: 显示「创建房间」「本地模式」「加入房间」「用户信息」「登出」
  - **所有状态**: 英雄选择功能始终可用，本地模式和在线模式共享相同的英雄选择界面

### 状态管理架构
- **Decision**: 本地模式保持现有的 React useState + localStorage，在线模式新增 Supabase 客户端状态层
- **理由**: 最小化本地模式变更，渐进式升级，降低迁移风险
- **架构**:
  - 本地模式：完全独立的 localStorage 状态管理
  - 在线模式：Supabase + React Query 状态管理
  - 功能切换：通过按钮点击直接激活相应功能，无需模式切换开关

## Risks / Trade-offs

### 技术风险
- **风险**: Supabase 服务稳定性依赖外部服务
- **缓解**: 实现离线缓存和降级策略，保持本地功能可用

- **风险**: 实时同步的性能瓶颈
- **缓解**: 实现增量同步，优化数据结构，设置合理的订阅频率

### 架构权衡
- **权衡**: 从纯前端应用变为全栈应用，增加复杂性
- **收益**: 功能大幅扩展，支持多人协作，提升用户价值

- **权衡**: 引入新的外部依赖（Supabase）
- **收益**: 避免自建后端的复杂性，快速获得生产就绪的基础设施

### 用户体验权衡
- **权衡**: 需要用户注册登录，增加使用门槛
- **收益**: 提供持久化和协作功能，长期价值更高

## Migration Plan

### 阶段 1: 基础设施（1-2 周）
1. 设置 Supabase 项目和数据库
2. 配置开发环境和依赖
3. 实现基础的用户认证
4. 创建核心数据表结构

### 阶段 2: 核心功能（2-3 周）
1. 实现房间创建和管理
2. 开发 BP 状态实时同步
3. 添加权限控制系统
4. 实现用户界面更新

### 阶段 3: 优化和完善（1-2 周）
1. 性能优化和错误处理
2. 数据迁移和兼容性
3. 用户体验优化
4. 测试和文档

### 阶段 4: 部署和监控（1 周）
1. 生产环境部署
2. 监控和日志设置
3. 用户培训和文档
4. 反馈收集和迭代

## Open Questions

### 技术问题
- 如何处理大量用户的实时订阅开销？
- 是否需要实现房间人数限制？
- 如何优化移动端的网络连接体验？

### 产品问题
- 房间的生命周期应该如何管理（自动删除 vs 永久保存）？
- 是否需要支持房间模板功能？
- 如何平衡匿名用户体验和注册转化？

### 业务问题
- Supabase 免费层级的限制是否满足初期需求？
- 何时考虑付费升级或自建后端？
- 如何处理用户数据的隐私和合规要求？

## Rollback Strategy
如果 Supabase 集成遇到重大问题：
1. 保持现有 localStorage 功能完全可用
2. 通过功能开关控制新功能的启用
3. 可以快速回退到纯本地版本
4. 用户数据不会丢失，只是无法协作