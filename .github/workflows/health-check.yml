name: Weekly Supabase Health Check

on:
  schedule:
    # æ¯å‘¨ä¸€ä¸Šåˆ 10:00 UTC è¿è¡Œ (ç›¸å½“äºåŒ—äº¬æ—¶é—´ 18:00)
    - cron: '0 10 * * 1'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  health-check:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run Supabase Health Check
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      run: |
        echo "ğŸ” å¼€å§‹ Supabase é¡¹ç›®å¥åº·æ£€æŸ¥..."

        # æ£€æŸ¥ç¯å¢ƒå˜é‡
        if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_ANON_KEY" ]; then
          echo "âŒ ç¼ºå°‘å¿…è¦çš„ç¯å¢ƒå˜é‡"
          exit 1
        fi

        echo "ğŸ“¡ æ£€æŸ¥ Supabase API è¿æ¥..."

        # ä½¿ç”¨ curl æ£€æŸ¥ API å¥åº·çŠ¶æ€
        response=$(curl -s -w "%{http_code}" \
          -H "apikey: $SUPABASE_ANON_KEY" \
          -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
          "$SUPABASE_URL/rest/v1/" \
          -o /dev/null)

        if [ "$response" = "200" ]; then
          echo "âœ… Supabase API è¿æ¥æ­£å¸¸ (HTTP $response)"
        else
          echo "âŒ Supabase API è¿æ¥å¤±è´¥ (HTTP $response)"
          exit 1
        fi

        echo "ğŸ“Š æ£€æŸ¥æ•°æ®åº“è¿æ¥..."

        # å°è¯•æŸ¥è¯¢æ•°æ®åº“ä¿¡æ¯ï¼ˆæ›´å¯é çš„æ–¹æ³•ï¼‰
        db_response=$(curl -s -w "%{http_code}" \
          -H "apikey: $SUPABASE_ANON_KEY" \
          -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
          "$SUPABASE_URL/rest/v1/" \
          -o /dev/null)

        # å¦‚æœ API è¿æ¥æ­£å¸¸ï¼Œæ•°æ®åº“ä¹Ÿåº”è¯¥æ­£å¸¸
        if [ "$db_response" = "200" ]; then
          echo "âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸ (é€šè¿‡ API æ£€æŸ¥)"
        else
          echo "âŒ æ•°æ®åº“è¿æ¥å¤±è´¥ (HTTP $db_response)"
          exit 1
        fi

        # å°è¯•æ£€æŸ¥ auth ç³»ç»ŸçŠ¶æ€
        auth_response=$(curl -s -w "%{http_code}" \
          -H "apikey: $SUPABASE_ANON_KEY" \
          -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
          "$SUPABASE_URL/auth/v1/settings" \
          -o /dev/null)

        if [ "$auth_response" = "200" ]; then
          echo "âœ… Auth ç³»ç»Ÿæ­£å¸¸ (HTTP $auth_response)"
        else
          echo "âš ï¸ Auth ç³»ç»Ÿå¯èƒ½æœ‰é—®é¢˜ (HTTP $auth_response)"
        fi

        echo "ğŸ”¥ æ£€æŸ¥ Edge Functions..."

        # æ£€æŸ¥ Edge Functions æ˜¯å¦å¯è®¿é—®
        edge_response=$(curl -s -w "%{http_code}" \
          -H "apikey: $SUPABASE_ANON_KEY" \
          -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
          "$SUPABASE_URL/functions/v1/check-email" \
          -o /dev/null)

        if [ "$edge_response" = "404" ] || [ "$edge_response" = "200" ]; then
          echo "âœ… Edge Functions æœåŠ¡æ­£å¸¸ (HTTP $edge_response)"
        else
          echo "âš ï¸ Edge Functions å¯èƒ½æœªéƒ¨ç½² (HTTP $edge_response)"
        fi

        echo "ğŸ‰ å¥åº·æ£€æŸ¥å®Œæˆï¼é¡¹ç›®ä¿æŒæ´»è·ƒçŠ¶æ€ã€‚"
        echo "ğŸ“… æ£€æŸ¥æ—¶é—´: $(date)"
        echo "ğŸŒ é¡¹ç›®URL: $SUPABASE_URL"