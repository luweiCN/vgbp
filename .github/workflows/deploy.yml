# GitHub Actions éƒ¨ç½²é…ç½®
# åŒ…å« Supabase çŽ¯å¢ƒå˜é‡çš„å®‰å…¨é…ç½®

name: Deploy to GitHub Pages

on:
  push:
    branches: [ main, feature/supabase-realtime-sync ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18
        cache: 'npm'

    - name: Install dependencies
      run: npm install

    - name: Validate environment variables
      run: |
        echo "ðŸ” Validating required secrets..."
        if [[ -z "${{ secrets.SUPABASE_URL }}" ]]; then
          echo "âŒ SUPABASE_URL secret is missing or empty"
          echo "ðŸ’¡ Please add SUPABASE_URL to repository secrets"
          echo "ðŸ“‹ Value should be: https://hvbqzfdmmoupwvbwegug.supabase.co"
          exit 1
        fi
        if [[ -z "${{ secrets.SUPABASE_ANON_KEY }}" ]]; then
          echo "âŒ SUPABASE_ANON_KEY secret is missing or empty"
          echo "ðŸ’¡ Please add SUPABASE_ANON_KEY to repository secrets"
          echo "ðŸ“‹ Value should start with: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
          exit 1
        fi
        if [[ -z "${{ secrets.GEMINI_API_KEY }}" ]]; then
          echo "âš ï¸ GEMINI_API_KEY secret is missing (AI features will be disabled)"
        fi
        echo "âœ… All required secrets are present!"

    - name: Build with environment variables
      run: |
        # åˆ›å»º .env æ–‡ä»¶ç”¨äºŽæž„å»º
        cat > .env << EOF
        VITE_SUPABASE_URL=${{ secrets.SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
        GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
        # GitHub Pages å­è·¯å¾„é…ç½®
        VERCEL=false
        EOF

        # éªŒè¯çŽ¯å¢ƒå˜é‡è®¾ç½®ï¼ˆä¸æ˜¾ç¤ºå®Œæ•´å€¼ä»¥ä¿è¯å®‰å…¨ï¼‰
        echo "ðŸ”§ Environment file created with variables:"
        echo "  - VITE_SUPABASE_URL: ${VITE_SUPABASE_URL:0:20}..."
        echo "  - VITE_SUPABASE_ANON_KEY: $(grep -o '^VITE_SUPABASE_ANON_KEY=ey' .env | cut -c1-30)..."
        echo "  - GEMINI_API_KEY: $(if [[ -n "${{ secrets.GEMINI_API_KEY }}" ]]; then echo "âœ… Set"; else echo "âŒ Not set"; fi)"

        # æž„å»ºé¡¹ç›®
        echo "ðŸ—ï¸ Starting build process..."
        npm run build

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: dist

  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4